- name: Make lists for packages
  ansible.builtin.set_fact:
    native_list: []
    brew_list: []
    flatpak_list: []

- name: Populate lists
  ansible.builtin.set_fact:
    native_list: "{{ native_list + [package_name] if method == 'native' and package_name else native_list }}"
    brew_list: "{{ brew_list + [package_name] if method == 'brew' and package_name else brew_list }}"
    flatpak_list: "{{ flatpak_list + [package_name] if method == 'flatpak' and package_name else flatpak_list }}"
  vars:
    details: "{{ package_details[item] | default({}) }}"
    method: "{{ details.method | default('native') }}"
    package_name: "{{ details.name | default(item) }}"
  loop: "{{ package_list }}"

- name: Debug
  ansible.builtin.debug:
    msg:
      - "Packages to be installed"
      - "Native pkg mgr: {{ native_list }}"
      - "Linuxbrew: {{ brew_list }}"
      - "Flatpak: {{ flatpak_list }}"

- name: Install packages via native package manager
  ansible.builtin.package:
    name: "{{ native_list }}"
    state: present
  become: true
  when: native_list | length > 0

- name: Install packages via brew
  community.general.homebrew:
    name: "{{ brew_list }}"
    state: present
  when: brew_list | length > 0 and ansible_facts["os_family"] != "Archlinux"

- name: Install packages via flatpak
  community.general.flatpak:
    name: "{{ flatpak_list }}"
    state: present
  when: flatpak_list | length > 0 and not ephemeral | bool
