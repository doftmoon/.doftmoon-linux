- name: Configure my Linux
  hosts: localhost
  gather_facts: false

  pre_tasks:
    - name: Gather only needed facts
      ansible.builtin.setup:
        gather_subset:
          - "!all"
          - "!min"
          - "env"
          - "user_id"
          - "platform"
          - "distribution"

    - name: Set device and profile type
      ansible.builtin.set_fact:
        ephemeral: >-
          {{ ansible_facts["env.CODESPACES"] | default(false) or
            ansible_facts["env.REMOTE_CONTAINER_IPC"] | default(false) or
            ansible_facts["user_id"] in ["root", "ubuntu", "vagrant", "vscode"] }}
        personal: >-
          {{ (ansible_facts["user_id"] | default("")) == "doftmoon" }}
        ubuntu24lts: >-
          {{ ansible_facts["distribution"] == "Ubuntu" | default(true) and
            ansible_facts["distribution_major_version"] | int >= 24 }}

    - name: Debug
      ansible.builtin.debug:
        msg:
          - "Is ephemeral: {{ ephemeral }}"
          - "Is personal: {{ personal }}"
          - "Is Ubuntu 24 lts: {{ ubuntu24lts }}"

  roles:
    - role: core
      tags: ["1", "core", "common", "base"]

    - role: desktop
      tags: ["2", "desktop"]
      when: not ephemeral | bool

    - role: packages
      tags: ["3", "apps"]

    # - role: security
    #   tags: ["4", "sec"]

    # - role: system_configs
    #   tags: ["5", "sys_conf"]

    - role: dotfiles
      tags: ["5", "dotfiles"]
      vars:
        dotfiles_github_user: "doftmoon"
